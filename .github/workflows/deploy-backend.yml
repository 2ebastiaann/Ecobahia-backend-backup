name: ðŸš€ Deploy Backend ecoBahia (VPS)

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Instalar dependencias y Build
        run: |
          cd Back-End-ecobahia/sistema-backend
          npm install
          npm run build --if-present

      - name: ðŸ§© Preparar carpeta de despliegue
        run: |
          rm -rf deploy-backend
          mkdir deploy-backend

          # ðŸ”¥ COPIAR TODO el backend completo (soluciÃ³n al error)
          cp -r Back-End-ecobahia/sistema-backend/* deploy-backend/

      - name: ðŸ§¹ Limpiar carpeta en servidor
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            TARGET="/var/www/jorge_site/backend"
            mkdir -p $TARGET
            find $TARGET -maxdepth 1 -mindepth 1 -not -name 'node_modules' -not -name '.env' -delete
            echo "âœ” Carpeta $TARGET limpia y lista"

      - name: ðŸ“¤ Subir backend al servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "deploy-backend/*"
          target: "/var/www/jorge_site/backend/"
          strip_components: 1
          overwrite: true

      - name: âš™ Instalar dependencias y Reiniciar (PM2)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            cd /var/www/jorge_site/backend
            npm install --production
            chmod -R 755 .
            pm2 restart eco-api || pm2 start server.js --name "eco-api"
            pm2 save
            echo "âœ” Deploy Backend finalizado en /var/www/jorge_site/backend"
