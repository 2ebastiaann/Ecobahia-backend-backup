name: ðŸš€ Deploy Backend ecoBahia (VPS)

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # ----------------- CHECKOUT -----------------
      - name: ðŸ§© Checkout cÃ³digo
        uses: actions/checkout@v4

      # ----------------- NODE SETUP -----------------
      - name: âš™ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ----------------- INSTALAR Y COMPILAR LOCALMENTE -----------------
      - name: ðŸ“¦ Instalar dependencias y Build
        run: |
          cd Back-End-ecobahia
          npm install
          # Si tienes script de build (ej. tsc), esto lo ejecuta. Si no, no pasa nada.
          npm run build --if-present 

      # ----------------- PREPARAR ARCHIVOS -----------------
      - name: ðŸ§© Preparar carpeta de despliegue
        run: |
          rm -rf deploy-backend
          mkdir deploy-backend
          
          # 1. Copiamos package.json y lock (CRUCIAL para backend)
          cp Back-End-ecobahia/package*.json deploy-backend/
          
          # 2. Copiamos el cÃ³digo. 
          # OPCIÃ“N A: Si usas TypeScript y tienes carpeta 'dist':
          cp -r Back-End-ecobahia/dist deploy-backend/ 2>/dev/null || :
          
          # OPCIÃ“N B: Si es JS puro, copiamos src o archivos raÃ­z.
          # (Esta lÃ­nea copia todo lo que termine en .js de la raÃ­z del backend por si acaso)
          cp Back-End-ecobahia/*.js deploy-backend/ 2>/dev/null || :
          
          # OPCIÃ“N C: Copiar carpeta src si existe
          cp -r Back-End-ecobahia/src deploy-backend/ 2>/dev/null || :

      # ----------------- LIMPIAR SERVIDOR -----------------
      - name: ðŸ§¹ Limpiar carpeta en servidor
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            # Mantenemos la ruta /var/www/ como pediste
            TARGET="/var/www/ecobahia_backend"
            
            # Borramos contenido previo excepto node_modules (para ahorrar tiempo de instalaciÃ³n)
            # Si no existe la carpeta, no da error
            mkdir -p $TARGET
            find $TARGET -maxdepth 1 -mindepth 1 -not -name 'node_modules' -delete
            echo "âœ” Carpeta $TARGET limpia y lista"

      # ----------------- SUBIR ARCHIVOS -----------------
      - name: ðŸ“¤ Subir backend al servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "deploy-backend/*"
          target: "/var/www/ecobahia_backend/" # ðŸ‘ˆ Tu ruta solicitada
          strip_components: 1
          overwrite: true

      # ----------------- CONFIG FINAL Y REINICIO -----------------
      - name: âš™ Instalar dependencias y Reiniciar (PM2)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            cd /var/www/ecobahia_backend
            
            echo "ðŸ“¦ Instalando dependencias de producciÃ³n..."
            npm install --production

            # Ajustar permisos si es necesario
            chmod -R 755 .

            echo "ðŸ”„ Reiniciando servidor con PM2..."
            # Asumiendo que usas PM2 en tu VPS Hostinger
            # 'eco-api' es el nombre que le daremos al proceso en PM2
            
            # Intenta reiniciar, si falla (porque no existe), lo inicia
            pm2 restart eco-api || pm2 start index.js --name "eco-api"
            
            # Guarda la configuraciÃ³n para que arranque si se reinicia el VPS
            pm2 save
            
            echo "âœ” Deploy Backend finalizado en /var/www/ecobahia_backend"
