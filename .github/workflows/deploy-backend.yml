name: ðŸš€ Deploy Backend ecoBahia (VPS)

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # ----------------- CHECKOUT -----------------
      - name: ðŸ§© Checkout cÃ³digo
        uses: actions/checkout@v4

      # ----------------- NODE SETUP -----------------
      - name: âš™ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ----------------- INSTALAR Y COMPILAR LOCALMENTE -----------------
      - name: ðŸ“¦ Instalar dependencias y Build
        run: |
          cd Back-End-ecobahia/sistema-backend
          npm install
          # Si tienes script de build (ej. tsc), esto lo ejecuta. Si no, no pasa nada.
          npm run build --if-present 

      # ----------------- PREPARAR ARCHIVOS -----------------
      - name: ðŸ§© Preparar carpeta de despliegue
        run: |
          rm -rf deploy-backend
          mkdir deploy-backend
          
          # 1. Copiamos package.json y lock
          cp Back-End-ecobahia/sistema-backend/package*.json deploy-backend/
          
          # 2. Copiamos archivos .js del backend
          cp Back-End-ecobahia/sistema-backend/*.js deploy-backend/ 2>/dev/null || :
          
          # 3. Copiar carpeta src si existe
          cp -r Back-End-ecobahia/sistema-backend/src deploy-backend/ 2>/dev/null || :
          
          # 4. Copiar carpeta dist si existiera
          cp -r Back-End-ecobahia/sistema-backend/dist deploy-backend/ 2>/dev/null || :

      # ----------------- LIMPIAR SERVIDOR -----------------
      - name: ðŸ§¹ Limpiar carpeta en servidor
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            TARGET="/var/www/ecobahia_backend"
            
            mkdir -p $TARGET
            find $TARGET -maxdepth 1 -mindepth 1 -not -name 'node_modules' -delete
            echo "âœ” Carpeta $TARGET limpia y lista"

      # ----------------- SUBIR ARCHIVOS -----------------
      - name: ðŸ“¤ Subir backend al servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "deploy-backend/*"
          target: "/var/www/ecobahia_backend/"
          strip_components: 1
          overwrite: true

      # ----------------- CONFIG FINAL Y REINICIO -----------------
      - name: âš™ Instalar dependencias y Reiniciar (PM2)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            cd /var/www/ecobahia_backend
            
            echo "ðŸ“¦ Instalando dependencias de producciÃ³n..."
            npm install --production

            chmod -R 755 .

            echo "ðŸ”„ Reiniciando servidor con PM2..."
            pm2 restart eco-api || pm2 start index.js --name "eco-api"
            pm2 save

            echo "âœ” Deploy Backend finalizado en /var/www/ecobahia_backend"
